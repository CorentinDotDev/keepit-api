// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    Int               @id @default(autoincrement())
  email                 String            @unique
  password              String
  notes                 Note[]
  webhooks              Webhook[]
  refreshTokens         RefreshToken[]
  apiKeys               ApiKey[]
  sentInvitations       NoteInvitation[]  @relation("InvitationsSent")
  receivedInvitations   NoteInvitation[]  @relation("InvitationsReceived")
  noteAccess            NoteAccess[]      @relation("NoteAccess")
  grantedAccess         NoteAccess[]      @relation("AccessGranted")

  @@map("users")
}

model Note {
  id          Int              @id @default(autoincrement())
  title       String
  content     String
  color       String?
  isPinned    Boolean          @default(false)
  isShared    Boolean          @default(false)
  isTemplate  Boolean          @default(false)
  order       Int              @default(0)
  userId      Int
  user        User             @relation(fields: [userId], references: [id])
  checkboxes  Checkbox[]
  invitations NoteInvitation[]
  accessRights NoteAccess[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("notes")
}

model Checkbox {
  id      Int     @id @default(autoincrement())
  label   String
  checked Boolean @default(false)
  noteId  Int
  note    Note    @relation(fields: [noteId], references: [id])

  @@map("checkboxes")
}

model Webhook {
  id     Int    @id @default(autoincrement())
  action String?
  url    String?
  userId Int
  user   User   @relation(fields: [userId], references: [id])

  @@map("webhooks")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}

model NoteInvitation {
  id              Int       @id @default(autoincrement())
  noteId          Int
  note            Note      @relation(fields: [noteId], references: [id], onDelete: Cascade)
  invitedEmail    String
  invitedById     Int
  invitedBy       User      @relation("InvitationsSent", fields: [invitedById], references: [id])
  permission      String    @default("READ") // READ, WRITE, ADMIN
  status          String    @default("PENDING") // PENDING, ACCEPTED, DECLINED, EXPIRED, REVOKED
  token           String    @unique
  message         String?
  expiresAt       DateTime
  acceptedAt      DateTime?
  acceptedById    Int?
  acceptedBy      User?     @relation("InvitationsReceived", fields: [acceptedById], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([noteId, invitedEmail])
  @@map("note_invitations")
}

model NoteAccess {
  id         Int      @id @default(autoincrement())
  noteId     Int
  note       Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  userId     Int
  user       User     @relation("NoteAccess", fields: [userId], references: [id])
  permission String   @default("READ") // READ, WRITE, ADMIN
  grantedAt  DateTime @default(now())
  grantedBy  Int
  grantor    User     @relation("AccessGranted", fields: [grantedBy], references: [id])

  @@unique([noteId, userId])
  @@map("note_access")
}

model ApiKey {
  id          Int       @id @default(autoincrement())
  name        String
  key         String    @unique
  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissions String
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@map("api_keys")
}